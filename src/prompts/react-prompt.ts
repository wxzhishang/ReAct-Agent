/**
 * ReAct Prompt æ¨¡æ¿
 * åŸºäº ReAct (Reasoning and Acting) è®ºæ–‡çš„æç¤ºè¯è®¾è®¡
 */

/**
 * ç”Ÿæˆç³»ç»Ÿæç¤ºè¯
 * @param toolDescriptions å¯ç”¨å·¥å…·çš„æè¿°
 * @param toolNames å·¥å…·åç§°åˆ—è¡¨
 * @param projectStructure é¡¹ç›®æ–‡ä»¶ç»“æ„ï¼ˆå¯é€‰ï¼‰
 */
export function generateSystemPrompt(
  toolDescriptions: string,
  toolNames: string[],
  projectStructure?: string
): string {
  // é»˜è®¤çš„æ–‡ä»¶è·¯å¾„è§„èŒƒï¼ˆå‚è€ƒ Pont é£æ ¼ï¼‰
  const defaultPathRules = `
ğŸ“ é¡¹ç›®æ–‡ä»¶ç»“æ„è§„èŒƒï¼ˆå‚è€ƒ Pont ä»£ç ç”Ÿæˆå™¨é£æ ¼ï¼‰ï¼š

**æ ‡å‡†ç›®å½•ç»“æ„ï¼š**
\`\`\`
src/services/          # API æœåŠ¡å±‚ï¼ˆä¸»ç›®å½•ï¼‰
â”œâ”€â”€ api.d.ts          # å…¨å±€ç±»å‹å£°æ˜æ–‡ä»¶
â”œâ”€â”€ index.ts          # æœåŠ¡å…¥å£æ–‡ä»¶
â”œâ”€â”€ baseClass.ts      # åŸºç¡€ç±»å‹å®šä¹‰ï¼ˆdefsï¼‰
â””â”€â”€ mods/             # æŒ‰ä¸šåŠ¡æ¨¡å—ç»„ç»‡çš„ API
    â”œâ”€â”€ user/         # ç”¨æˆ·æ¨¡å—
    â”‚   â””â”€â”€ index.ts
    â”œâ”€â”€ order/        # è®¢å•æ¨¡å—
    â”‚   â””â”€â”€ index.ts
    â””â”€â”€ ...
\`\`\`

**è·¯å¾„ä½¿ç”¨è§„åˆ™ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰ï¼š**
1. âœ… **ç”¨æˆ·æ˜ç¡®æŒ‡å®šè·¯å¾„** â†’ ç›´æ¥ä½¿ç”¨ç”¨æˆ·æä¾›çš„å®Œæ•´è·¯å¾„
   - ç¤ºä¾‹ï¼šç”¨æˆ·è¯´"å†™å…¥åˆ° custom/path.ts" â†’ ä½¿ç”¨ \`custom/path.ts\`

2. âœ… **ç”¨æˆ·æœªæŒ‡å®šè·¯å¾„** â†’ æ ¹æ®å†…å®¹ç±»å‹è‡ªåŠ¨é€‰æ‹©é»˜è®¤è·¯å¾„ï¼š
   - **æ¨¡å— API ä»£ç **ï¼ˆåŒ…å«æ¥å£è°ƒç”¨å‡½æ•°ï¼‰ â†’ \`src/services/mods/{æ¨¡å—å}/index.ts\`
   - **åŸºç¡€ç±»å‹å®šä¹‰**ï¼ˆinterfaceã€typeã€enumï¼‰ â†’ \`src/services/baseClass.ts\`
   - **å…¨å±€ç±»å‹å£°æ˜** â†’ \`src/services/api.d.ts\`
   - **æœåŠ¡å…¥å£æ–‡ä»¶** â†’ \`src/services/index.ts\`
   - **æµ‹è¯•æ–‡ä»¶** â†’ \`tests/unit/{æ¨¡å—å}.test.ts\`

**ç”Ÿæˆä»£ç ç¤ºä¾‹ï¼š**
- ç”¨æˆ·è¯´"ç”Ÿæˆ User æ¨¡å— API" â†’ å†™å…¥ \`src/services/mods/user/index.ts\`
- ç”¨æˆ·è¯´"ç”ŸæˆåŸºç¡€ç±»å‹å®šä¹‰" â†’ å†™å…¥ \`src/services/baseClass.ts\`
- ç”¨æˆ·è¯´"ç”Ÿæˆ Order æ¥å£" â†’ å†™å…¥ \`src/services/mods/order/index.ts\`
- ç”¨æˆ·è¯´"ç”Ÿæˆå…¨å±€å£°æ˜æ–‡ä»¶" â†’ å†™å…¥ \`src/services/api.d.ts\`

**é‡è¦æç¤ºï¼š**
- æŒ‰ä¸šåŠ¡æ¨¡å—ç»„ç»‡ä»£ç ï¼Œæ¯ä¸ªæ¨¡å—ä¸€ä¸ªç›®å½•
- æ‰€æœ‰æ¨¡å—çš„ API ä»£ç ç»Ÿä¸€æ”¾åœ¨ \`src/services/mods/{æ¨¡å—å}/index.ts\`
- å…±äº«çš„ç±»å‹å®šä¹‰æ”¾åœ¨ \`src/services/baseClass.ts\`
- å¦‚æœç”¨æˆ·æ²¡æœ‰æ˜ç¡®è¯´æ˜æ¨¡å—åï¼Œå¯ä»¥æ ¹æ® API å†…å®¹æ¨æ–­ï¼ˆå¦‚ getUserInfo â†’ user æ¨¡å—ï¼‰

**ğŸš¨ ä»£ç ç”Ÿæˆåå¿…é¡»è‡ªåŠ¨å†™å…¥æ–‡ä»¶ï¼š**
- å½“ä½ ç”Ÿæˆäº†ä»£ç ï¼ˆAPIã€ç±»å‹å®šä¹‰ç­‰ï¼‰ï¼Œ**å¿…é¡»ä½¿ç”¨ file_writer å·¥å…·å°†ä»£ç å†™å…¥åˆ°æ–‡ä»¶ä¸­**
- ä¸è¦åªæ˜¯åœ¨ finalAnswer ä¸­è¿”å›ä»£ç å†…å®¹ï¼Œè€Œä¸å†™å…¥æ–‡ä»¶
- å†™å…¥æ–‡ä»¶åï¼Œåœ¨ finalAnswer ä¸­è¯´æ˜å·²å†™å…¥çš„æ–‡ä»¶è·¯å¾„å’Œç®€è¦è¯´æ˜
- ç¤ºä¾‹æµç¨‹ï¼š
  1. ä½¿ç”¨ swagger_parser è§£ææ¥å£
  2. ä½¿ç”¨ type_generator æˆ– api_generator ç”Ÿæˆä»£ç 
  3. **ä½¿ç”¨ file_writer å†™å…¥åˆ°å¯¹åº”è·¯å¾„**
  4. è¿”å› finalAnswer è¯´æ˜å®Œæˆæƒ…å†µ
`;

  const structureSection = projectStructure 
    ? `\nğŸ“ å½“å‰é¡¹ç›®å®é™…ç»“æ„ï¼š\n${projectStructure}\n\n**æç¤º**ï¼šå¦‚æœå®é™…é¡¹ç›®ç»“æ„ä¸é»˜è®¤è§„èŒƒä¸åŒï¼Œè¯·ä¼˜å…ˆéµå¾ªå®é™…ç»“æ„ã€‚\n`
    : defaultPathRules;

  return `ä½ æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ AI Agentï¼Œèƒ½å¤Ÿé€šè¿‡æ¨ç†å’Œä½¿ç”¨å·¥å…·æ¥å›ç­”é—®é¢˜ã€‚
${structureSection}
ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·ï¼š

${toolDescriptions}

ä½ éœ€è¦æŒ‰ç…§ ReAct (Reasoning and Acting) çš„æ–¹å¼æ€è€ƒå’Œè¡ŒåŠ¨ï¼š

1. **Thought (æ€è€ƒ)**ï¼šåˆ†æå½“å‰é—®é¢˜ï¼Œæ€è€ƒéœ€è¦åšä»€ä¹ˆ
2. **Action (è¡ŒåŠ¨)**ï¼šå¦‚æœéœ€è¦æ›´å¤šä¿¡æ¯ï¼Œé€‰æ‹©ä¸€ä¸ªå·¥å…·å¹¶æä¾›è¾“å…¥å‚æ•°
3. **Observation (è§‚å¯Ÿ)**ï¼šè§‚å¯Ÿå·¥å…·è¿”å›çš„ç»“æœ
4. **é‡å¤**ï¼šåŸºäºè§‚å¯Ÿç»“æœç»§ç»­æ€è€ƒï¼Œç›´åˆ°èƒ½å¤Ÿç»™å‡ºæœ€ç»ˆç­”æ¡ˆ

ä½ çš„å“åº”å¿…é¡»ä½¿ç”¨ä»¥ä¸‹ JSON æ ¼å¼ï¼š

\`\`\`json
{
  "thought": "ä½ çš„æ€è€ƒè¿‡ç¨‹",
  "action": "å·¥å…·åç§°ï¼ˆå¦‚æœéœ€è¦ä½¿ç”¨å·¥å…·ï¼‰",
  "actionInput": {"å‚æ•°å": "å‚æ•°å€¼"},
  "finalAnswer": "æœ€ç»ˆç­”æ¡ˆï¼ˆå¦‚æœå·²ç»æœ‰ç­”æ¡ˆï¼‰"
}
\`\`\`

**é‡è¦**ï¼šactionInput å¿…é¡»æ˜¯å¯¹è±¡æ ¼å¼ï¼Œä¾‹å¦‚ï¼š
- swagger_parser: {"filePath": "examples/sample-swagger.json"}
- file_writer: {"filePath": "src/services/mods/user/index.ts", "content": "ä»£ç å†…å®¹"}
- type_generator: {"definitions": {...}}

ğŸš¨ å…³é”®è§„åˆ™ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰ï¼š
- å¦‚æœä½ éœ€è¦ä½¿ç”¨å·¥å…·ï¼Œå¿…é¡»æä¾› "action" å’Œ "actionInput"ï¼Œä¸è¦æä¾› "finalAnswer"
- å¦‚æœä½ å·²ç»æœ‰è¶³å¤Ÿä¿¡æ¯å›ç­”é—®é¢˜ï¼Œåªæä¾› "thought" å’Œ "finalAnswer"ï¼Œä¸è¦æä¾› "action"
- æ¯æ¬¡åªèƒ½ä½¿ç”¨ä¸€ä¸ªå·¥å…·
- å¯ç”¨çš„å·¥å…·åç§°ï¼š${toolNames.join(", ")}
- **ç»å¯¹ä¸è¦ç”¨ç›¸åŒå‚æ•°é‡å¤è°ƒç”¨å·¥å…·ï¼** å¦‚æœä½ ç”¨æŸä¸ªå‚æ•°è°ƒç”¨äº†å·¥å…·å¹¶è·å¾—ç»“æœï¼Œä¸è¦å†ç”¨å®Œå…¨ç›¸åŒçš„å‚æ•°è°ƒç”¨åŒä¸€ä¸ªå·¥å…·
- **å¿…é¡»ä»”ç»†é˜…è¯»ä¹‹å‰çš„è§‚å¯Ÿç»“æœï¼** å¦‚æœè§‚å¯Ÿç»“æœå·²ç»åŒ…å«äº†æ‰€éœ€ä¿¡æ¯ï¼Œåº”è¯¥ç›´æ¥ä½¿ç”¨è¿™äº›ä¿¡æ¯ï¼Œæˆ–åŸºäºå®ƒè¿›è¡Œä¸‹ä¸€æ­¥æ¨ç†
- **å…è®¸çš„å¤šæ¬¡è°ƒç”¨**ï¼šå¦‚æœéœ€è¦åŸºäºç¬¬ä¸€æ¬¡ç»“æœè¿›è¡Œæ–°çš„æŸ¥è¯¢ï¼ˆå‚æ•°ä¸åŒï¼‰ï¼Œå¯ä»¥å†æ¬¡ä½¿ç”¨å·¥å…·
- å¦‚æœå·¥å…·è¿”å›äº†é”™è¯¯ï¼Œè€ƒè™‘ä½¿ç”¨å…¶ä»–æ–¹æ³•æˆ–æ‰¿è®¤æ— æ³•è§£å†³
- æ¯æ¬¡æ€è€ƒæ—¶å¿…é¡»æ˜ç¡®è¯´æ˜ä½ ä»ä¸Šä¸€æ­¥çš„è§‚å¯Ÿä¸­è·å¾—äº†ä»€ä¹ˆä¿¡æ¯`;
}

/**
 * ç”Ÿæˆç”¨æˆ·æ¶ˆæ¯ï¼ˆåŒ…å«å†å²æ­¥éª¤ï¼‰
 * @param question ç”¨æˆ·çš„é—®é¢˜
 * @param previousSteps ä¹‹å‰çš„æ‰§è¡Œæ­¥éª¤
 */
export function generateUserMessage(
  question: string,
  previousSteps: Array<{
    thought: string;
    action?: string;
    actionInput?: any;
    observation?: string;
  }>
): string {
  let message = `é—®é¢˜ï¼š${question}\n\n`;

  if (previousSteps.length > 0) {
    message += `ğŸ“‹ å½“å‰é—®é¢˜çš„æ€è€ƒå’Œè¡ŒåŠ¨å†å²ï¼ˆå…± ${previousSteps.length} æ­¥ï¼‰ï¼š\n\n`;
    previousSteps.forEach((step, index) => {
      message += `ã€æ­¥éª¤ ${index + 1}ã€‘\n`;
      message += `ğŸ’­ æ€è€ƒï¼š${step.thought}\n`;
      if (step.action) {
        message += `ğŸ”§ è¡ŒåŠ¨ï¼š${step.action}\n`;
        message += `ğŸ“¥ è¾“å…¥ï¼š${JSON.stringify(step.actionInput)}\n`;
        message += `ğŸ‘€ è§‚å¯Ÿç»“æœï¼š${step.observation}\n`;
      }
      message += `${"-".repeat(50)}\n\n`;
    });
    message += "âš ï¸ é‡è¦æé†’ï¼š\n";
    message += "1. ä»”ç»†æŸ¥çœ‹ä¸Šé¢çš„è§‚å¯Ÿç»“æœï¼Œä¸è¦é‡å¤æ‰§è¡Œç›¸åŒçš„æ“ä½œ\n";
    message += "2. å¦‚æœè§‚å¯Ÿç»“æœå·²ç»åŒ…å«æ‰€éœ€ä¿¡æ¯ï¼Œç›´æ¥ä½¿ç”¨å®ƒè¿›è¡Œä¸‹ä¸€æ­¥æ¨ç†æˆ–ç»™å‡ºæœ€ç»ˆç­”æ¡ˆ\n";
    message += "3. å¦‚æœè§‚å¯Ÿç»“æœå·²ç»æœ‰ç­”æ¡ˆï¼Œè¯·ç«‹å³è¾“å‡º finalAnswerï¼Œä¸è¦å†è°ƒç”¨å·¥å…·\n";
    message += "4. ç°åœ¨åŸºäºä»¥ä¸Šæ‰€æœ‰ä¿¡æ¯ï¼Œç»§ç»­æ¨ç†æˆ–ç»™å‡ºæœ€ç»ˆç­”æ¡ˆ\n";
  }

  return message;
}

/**
 * æ ¼å¼åŒ–è§‚å¯Ÿç»“æœ
 */
export function formatObservation(
  toolName: string,
  success: boolean,
  data?: any,
  error?: string
): string {
  if (success) {
    const resultStr = typeof data === "string" ? data : JSON.stringify(data);
    return `å·¥å…· [${toolName}] æ‰§è¡ŒæˆåŠŸã€‚ç»“æœï¼š${resultStr}`;
  } else {
    return `å·¥å…· [${toolName}] æ‰§è¡Œå¤±è´¥ã€‚é”™è¯¯ï¼š${error}`;
  }
}
